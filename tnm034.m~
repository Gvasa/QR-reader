function [strout] = tnm034(img)

close all;

img = img(:,:,1);

bwPic = im2bw(img);
bwPic = double(bwPic);
bwPic = preThresholding(bwPic);

figure;
imshow(bwPic);
hold on;
pause;

[coordsX, coordsY] = detectFiducial(bwPic);
[centroidMatrix] = findPoints(bwPic, coordsX, coordsY);
[newPic, pointNW] = transformPicture(centroidMatrix, img);


newBwPic = im2bw(newPic);
newBwPic = double(newBwPic);
[sizeX sizeY] = size(newBwPic); 
for i = 1:500
    for j = 1:512
        if (filled(i,j) == 0 && i > 1 && i < 500 && j > 1 && j < 512)
            nearest = newPic(i-1:i+1, j-1:j+1);
            nearest_filled = filled(i-1:i+1, j-1:j+1);

            newPic(i, j) = sum(sum(nearest .* nearest_filled)) / sum(nearest_filled(:));
        end
    end
end

newPic = newPic / max(newPic(:));
imshow(newBwPic);
pause;


[coordsX, coordsY] = detectFiducial(newBwPic);
[centroidMatrix] = findPoints(newBwPic, coordsX, coordsY);
boxSize = findBoxSize(centroidMatrix);
perfectPic = readImg(newPic, boxSize, centroidMatrix);
imgToChar(perfectPic);



